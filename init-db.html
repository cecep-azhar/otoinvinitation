<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DB Init ‚Äì BASNOM HIPMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="js/config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #e5e7eb; }
        .card { background: #111; border: 1px solid rgba(191,149,63,0.2); border-radius: 1rem; }
        .gold-gradient { background: linear-gradient(90deg, #BF953F, #FCF6BA, #B38728); }
        .gold-text { background: linear-gradient(135deg, #BF953F, #FCF6BA, #AA771C); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .btn-gold { background: linear-gradient(90deg, #BF953F, #FCF6BA, #B38728); color: #000; font-weight: 700; transition: filter 0.2s; }
        .btn-gold:hover { filter: brightness(1.1); }
        pre { background: #050505; border: 1px solid #222; border-radius: 0.5rem; padding: 1rem; font-size: 0.75rem; color: #4ade80; overflow-x: auto; white-space: pre-wrap; }
        .step { display: flex; gap: 0.75rem; align-items: flex-start; }
        .step-num { width: 24px; height: 24px; border-radius: 50%; background: rgba(191,149,63,0.15); border: 1px solid rgba(191,149,63,0.35); display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: 700; color: #B38728; flex-shrink: 0; margin-top: 2px; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="card max-w-lg w-full overflow-hidden">
        <div class="gold-gradient h-1 w-full"></div>
        <div class="p-8 space-y-6">
            <div class="text-center">
                <h1 class="text-xl font-bold gold-text">Database Initializer</h1>
                <p class="text-xs text-gray-500 mt-1">Jalankan SEKALI untuk membuat tabel di Turso DB</p>
            </div>

            <div class="space-y-3 text-sm text-gray-400">
                <div class="step"><div class="step-num">1</div><p>Pastikan <strong class="text-white">TURSO_URL</strong> dan <strong class="text-white">TURSO_TOKEN</strong> sudah diisi di <code class="text-yellow-600">js/config.js</code>.</p></div>
                <div class="step"><div class="step-num">2</div><p>Klik tombol di bawah. Tabel <code class="text-yellow-600">attendance</code> akan dibuat (aman jika sudah ada, tidak akan menghapus data).</p></div>
                <div class="step"><div class="step-num">3</div><p>Setelah berhasil, hapus atau lindungi akses halaman ini dari publik.</p></div>
            </div>

            <div class="text-xs text-gray-600">
                <p class="mb-1 text-gray-500">SQL yang akan dijalankan (aman diulang ‚Äì tidak menghapus data):</p>
                <pre>CREATE TABLE IF NOT EXISTS attendance (
  id           INTEGER  PRIMARY KEY AUTOINCREMENT,
  nama         TEXT     NOT NULL,
  komunitas    TEXT     NOT NULL,
  whatsapp     TEXT     NOT NULL,
  status       TEXT     NOT NULL DEFAULT 'Hadir',
  alasan       TEXT,
  invite_token TEXT     UNIQUE,
  checkin_at   DATETIME,
  wa_sent      INTEGER  DEFAULT 0,
  created_at   DATETIME DEFAULT CURRENT_TIMESTAMP
);
-- Kolom migrasi (aman jika kolom sudah ada):
ALTER TABLE attendance ADD COLUMN invite_token TEXT UNIQUE;
ALTER TABLE attendance ADD COLUMN checkin_at   DATETIME;
ALTER TABLE attendance ADD COLUMN wa_sent      INTEGER DEFAULT 0;</pre>
            </div>

            <button id="initBtn" onclick="initDB()" class="btn-gold w-full py-3 rounded-lg text-sm uppercase tracking-widest">
                Inisialisasi / Migrasi Database
            </button>

            <div id="result" class="hidden">
                <pre id="resultText"></pre>
            </div>
        </div>
        <div class="gold-gradient h-0.5 w-full opacity-30"></div>
    </div>

    <script>
    async function initDB() {
        const btn = document.getElementById('initBtn');
        const res = document.getElementById('result');
        const txt = document.getElementById('resultText');
        btn.disabled = true;
        btn.textContent = 'Memproses...';
        res.classList.remove('hidden');
        txt.textContent = 'Menghubungi Turso...\n';

        const log = (msg) => { txt.textContent += msg + '\n'; };

        try {
            // Step 1: Create table (idempotent)
            log('‚ñ∂ Membuat tabel attendance...');
            await CONFIG.tursoFetch([{
                type: "execute",
                stmt: {
                    sql: `CREATE TABLE IF NOT EXISTS attendance (
                            id           INTEGER  PRIMARY KEY AUTOINCREMENT,
                            nama         TEXT     NOT NULL,
                            komunitas    TEXT     NOT NULL,
                            whatsapp     TEXT     NOT NULL,
                            status       TEXT     NOT NULL DEFAULT 'Hadir',
                            alasan       TEXT,
                            invite_token TEXT     UNIQUE,
                            checkin_at   DATETIME,
                            wa_sent      INTEGER  DEFAULT 0,
                            created_at   DATETIME DEFAULT CURRENT_TIMESTAMP
                          )`
                }
            }]);
            log('‚úÖ Tabel attendance siap.\n');

            // Step 2: Migration ‚Äì add columns if not exist (ignore errors = column exists)
            log('‚ñ∂ Migrasi kolom (invite_token, checkin_at)...');
            for (const sql of [
                "ALTER TABLE attendance ADD COLUMN invite_token TEXT",
                "ALTER TABLE attendance ADD COLUMN checkin_at DATETIME",
                "ALTER TABLE attendance ADD COLUMN wa_sent INTEGER DEFAULT 0"
            ]) {
                try {
                    await CONFIG.tursoFetch([{ type:"execute", stmt:{ sql } }]);
                    log('  + ' + sql.split(' ').slice(4).join(' ') + ' ‚Üí ditambahkan.');
                } catch (e) {
                    // Turso returns error if column exists ‚Äì safe to ignore
                    log('  ~ kolom sudah ada, dilewati.');
                }
            }

            log('\nüéâ SELESAI! Database siap dengan semua fitur terbaru.');
            btn.textContent = '‚úÖ Selesai';
            btn.style.background = 'rgba(34,197,94,0.2)';
            btn.style.color = '#4ade80';
        } catch (err) {
            log('‚ùå ERROR: ' + err.message);
            btn.textContent = 'Coba Lagi';
            btn.disabled = false;
        }
    }
    </script>
</body>
</html>
