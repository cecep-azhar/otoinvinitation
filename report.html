<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard ‚Äì BASNOM HIPMI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- QR Scanner -->
    <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="js/config.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600&display=swap');

        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #e5e7eb; }

        .gold-gradient { background: linear-gradient(90deg, #BF953F, #FCF6BA, #B38728, #FBF5B7, #AA771C); }
        .gold-text {
            background: linear-gradient(135deg, #BF953F 0%, #FCF6BA 40%, #B38728 60%, #AA771C 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
        }

        .card { background: linear-gradient(145deg, #111, #191919); border: 1px solid rgba(191,149,63,0.18); border-radius: 1rem; }
        .card-sm { background: #101010; border: 1px solid rgba(191,149,63,0.15); border-radius: 0.75rem; }

        /* Login area */
        #loginArea { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }

        .input-field { background: #0d0d0d; border: 1px solid #2a2a2a; color: white; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-field:focus { border-color: #B38728; box-shadow: 0 0 0 2px rgba(179,135,40,0.15); outline: none; }

        .btn-gold {
            background: linear-gradient(90deg, #BF953F, #FCF6BA, #B38728);
            background-size: 200% auto; color: #000; font-weight: 700;
            transition: background-position 0.4s, transform 0.15s, box-shadow 0.2s;
            box-shadow: 0 4px 20px rgba(179,135,40,0.3);
        }
        .btn-gold:hover { background-position: right center; transform: translateY(-1px); }
        .btn-gold:active { transform: translateY(0); }

        /* Table */
        #reportArea { display: none; min-height: 100vh; padding: 2rem 1rem; }
        .tbl-wrap { overflow-x: auto; border-radius: 0.75rem; border: 1px solid rgba(191,149,63,0.15); }
        table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        thead tr { background: rgba(191,149,63,0.08); }
        th { padding: 0.75rem 1rem; text-align: left; font-size: 0.7rem; letter-spacing: 0.05em; text-transform: uppercase; color: #B38728; white-space: nowrap; border-bottom: 1px solid rgba(191,149,63,0.15); cursor: pointer; user-select: none; }
        th:hover { background: rgba(191,149,63,0.06); }
        th.sort-asc::after { content: ' ‚Üë'; color: #FCF6BA; }
        th.sort-desc::after { content: ' ‚Üì'; color: #FCF6BA; }
        td { padding: 0.7rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: top; word-break: break-word; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: rgba(191,149,63,0.04); }

        .badge-hadir    { background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3); border-radius: 9999px; padding: 2px 10px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        .badge-tidak    { background: rgba(239,68,68,0.12); color: #f87171; border: 1px solid rgba(239,68,68,0.3); border-radius: 9999px; padding: 2px 10px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }

        .btn-del { color: #ef444480; transition: color 0.2s; background: none; border: none; cursor: pointer; padding: 2px 6px; border-radius: 4px; }
        .btn-del:hover { color: #ef4444; background: rgba(239,68,68,0.1); }

        /* Stat cards */
        .stat-card { border-radius: 0.75rem; padding: 1.25rem; border: 1px solid rgba(191,149,63,0.15); background: #101010; }

        /* Search/filter bar */
        .search-bar { background: #0d0d0d; border: 1px solid #2a2a2a; color: white; border-radius: 0.5rem; padding: 0.5rem 1rem; width: 100%; font-size: 0.85rem; }
        .search-bar:focus { border-color: #B38728; outline: none; }

        select.filter-sel { background: #0d0d0d; border: 1px solid #2a2a2a; color: white; border-radius: 0.5rem; padding: 0.5rem 0.75rem; font-size: 0.85rem; }
        select.filter-sel:focus { border-color: #B38728; outline: none; }

        /* Spinner */
        .spinner { border: 2px solid rgba(255,255,255,0.1); border-top-color: #B38728; border-radius: 50%; width: 24px; height: 24px; animation: spin 0.7s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* PIN dots */
        .pin-char { width: 14px; height: 14px; border-radius: 50%; background: #2a2a2a; transition: background 0.15s; }
        .pin-char.filled { background: #B38728; }

        /* Fade */
        .fade-in { animation: fadeIn 0.5s ease both; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:none; } }

        /* Confirm modal */
        #confirmModal { position:fixed; inset:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:9999; opacity:0; pointer-events:none; transition:opacity 0.25s; padding:1rem; }
        #confirmModal.show { opacity:1; pointer-events:all; }

        /* Toast */
        #toast { position:fixed; bottom:1.5rem; left:50%; transform:translateX(-50%) translateY(120%); transition:transform 0.4s cubic-bezier(0.34,1.56,0.64,1); z-index:99999; min-width:280px; max-width:90vw; border-radius:0.75rem; padding:0.85rem 1.1rem; }
        #toast.show { transform:translateX(-50%) translateY(0); }

        /* Empty state */
        #emptyState { display:none; }

        /* Scanner modal */
        #scanModal { position:fixed; inset:0; background:rgba(0,0,0,0.92); display:flex; align-items:center; justify-content:center; z-index:99990; opacity:0; pointer-events:none; transition:opacity 0.25s; padding:1rem; }
        #scanModal.show { opacity:1; pointer-events:all; }
        #scanVideo { width:100%; border-radius:0.75rem; }
        .scan-ring { position:absolute; inset:0; border:2px solid rgba(191,149,63,0.7); border-radius:0.75rem; pointer-events:none; animation: scanPulse 1.5s ease-in-out infinite; }
        @keyframes scanPulse { 0%,100%{opacity:1;} 50%{opacity:0.3;} }

        /* Check-in result modal */
        #checkinModal { position:fixed; inset:0; background:rgba(0,0,0,0.88); display:flex; align-items:center; justify-content:center; z-index:99995; opacity:0; pointer-events:none; transition:opacity 0.25s; padding:1rem; }
        #checkinModal.show { opacity:1; pointer-events:all; }

        /* Badge check-in */
        .badge-checkin { background: rgba(251,191,36,0.15); color: #fbbf24; border: 1px solid rgba(251,191,36,0.35); border-radius: 9999px; padding: 2px 10px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }
        /* Badge WA sent */
        .badge-wa-sent { background: rgba(34,197,94,0.12); color: #86efac; border: 1px solid rgba(34,197,94,0.3); border-radius: 9999px; padding: 2px 10px; font-size: 0.7rem; font-weight: 600; white-space: nowrap; }

        @media (max-width:640px) { th, td { padding: 0.5rem 0.6rem; } }
    </style>
</head>
<body>

<!-- ==================== LOGIN AREA ==================== -->
<div id="loginArea">
    <div class="card max-w-sm w-full overflow-hidden fade-in">
        <div class="gold-gradient h-1 w-full"></div>
        <div class="p-8 space-y-6">
            <div class="text-center">
                <h1 class="text-2xl font-bold gold-text" style="font-family:'Cinzel',serif;">Admin Dashboard</h1>
                <p class="text-xs text-gray-500 mt-1 tracking-widest uppercase">BASNOM HIPMI OTOMOTIF JABAR</p>
            </div>

            <!-- Setup warning -->
            <div id="setupWarnAdmin" class="hidden rounded-lg p-3 text-xs leading-relaxed" style="background:rgba(124,45,18,0.2);border:1px solid rgba(194,65,12,0.4);color:#fb923c;"></div>

            <div class="space-y-4">
                <div>
                    <label class="text-xs font-semibold uppercase text-yellow-600 tracking-wide block mb-2">Masukkan PIN Admin</label>
                    <!-- PIN dots visualizer -->
                    <div class="flex gap-2 justify-center mb-3" id="pinDots">
                        <div class="pin-char" id="dot0"></div><div class="pin-char" id="dot1"></div>
                        <div class="pin-char" id="dot2"></div><div class="pin-char" id="dot3"></div>
                        <div class="pin-char" id="dot4"></div><div class="pin-char" id="dot5"></div>
                        <div class="pin-char" id="dot6"></div><div class="pin-char" id="dot7"></div>
                    </div>
                    <input type="password" id="pinInput"
                        class="input-field w-full p-3 rounded-lg text-center text-lg tracking-widest"
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8" autocomplete="off">
                </div>
                <button onclick="checkPin()" class="btn-gold w-full py-3 rounded-lg text-sm uppercase tracking-widest">
                    Masuk
                </button>
                <p id="pinErr" class="text-red-400 text-xs text-center hidden">PIN salah. Coba lagi.</p>
            </div>
        </div>
        <div class="gold-gradient h-0.5 w-full opacity-30"></div>
    </div>
</div>

<!-- ==================== REPORT AREA ==================== -->
<div id="reportArea">

    <!-- Top bar -->
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
            <div>
                <h1 class="text-2xl font-bold gold-text" style="font-family:'Cinzel',serif;">Laporan Kehadiran</h1>
                <p class="text-xs text-gray-500 mt-0.5">Ceremonial, Talkshow & Buka Bersama ¬∑ 7 Maret 2026</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="openScanner()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm border border-yellow-500/40 text-yellow-400 hover:bg-yellow-500/10 transition font-semibold">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                    </svg>
                    Scan QR
                </button>
                <button onclick="loadData()" id="refreshBtn" class="flex items-center gap-2 px-4 py-2 rounded-lg text-sm border border-yellow-600/30 text-yellow-600 hover:bg-yellow-600/10 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    Refresh
                </button>
                <button onclick="exportExcel()" class="btn-gold flex items-center gap-2 px-4 py-2 rounded-lg text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v8a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
                    Export Excel
                </button>
                <button onclick="logout()" title="Keluar" class="px-3 py-2 rounded-lg text-sm border border-red-900/40 text-red-500 hover:bg-red-900/20 transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                </button>
            </div>
        </div>

        <!-- Stat Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-5 gap-3 mb-6">
            <div class="stat-card">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Total RSVP</p>
                <p class="text-3xl font-bold gold-text" id="statTotal">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Konfirmasi Hadir</p>
                <p class="text-3xl font-bold text-green-400" id="statHadir">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Tidak Hadir</p>
                <p class="text-3xl font-bold text-red-400" id="statTidak">‚Äî</p>
            </div>
            <div class="stat-card">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Tingkat Hadir</p>
                <p class="text-3xl font-bold text-yellow-400" id="statPct">‚Äî</p>
            </div>
            <div class="stat-card" style="border-color:rgba(251,191,36,0.3);">
                <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">‚úÖ Check-in</p>
                <p class="text-3xl font-bold text-yellow-300" id="statCheckin">‚Äî</p>
            </div>
        </div>

        <!-- Filter & Search bar -->
        <div class="flex flex-col sm:flex-row gap-3 mb-4">
            <input type="text" id="searchInput" class="search-bar flex-1" placeholder="üîç  Cari nama, komunitas, atau nomor WA..." oninput="renderTable()">
            <select id="filterStatus" class="filter-sel" onchange="renderTable()">
                <option value="">Semua Status</option>
                <option value="Hadir">‚úÖ Hadir</option>
                <option value="Tidak Hadir">‚ùå Tidak Hadir</option>
            </select>
            <select id="filterCheckin" class="filter-sel" onchange="renderTable()">
                <option value="">Semua Check-in</option>
                <option value="yes">üé´ Sudah Check-in</option>
                <option value="no">‚è≥ Belum Check-in</option>
            </select>
            <select id="filterKomunitas" class="filter-sel" onchange="renderTable()">
                <option value="">Semua Komunitas</option>
            </select>
        </div>

        <!-- Table -->
        <div class="card overflow-hidden">
            <!-- Loading -->
            <div id="loadingState" class="flex items-center justify-center py-20 gap-3">
                <div class="spinner"></div>
                <span class="text-gray-500 text-sm">Memuat data...</span>
            </div>

            <!-- Empty -->
            <div id="emptyState" class="text-center py-20 text-gray-600">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
                <p>Belum ada data.</p>
            </div>

            <div class="tbl-wrap" id="tableWrap" style="display:none;">
                <table id="attendanceTable">
                    <thead>
                        <tr>
                            <th style="width:40px">#</th>
                            <th onclick="sortBy('nama')">Nama</th>
                            <th onclick="sortBy('komunitas')">Komunitas</th>
                            <th onclick="sortBy('whatsapp')">WhatsApp</th>
                            <th onclick="sortBy('status')">RSVP</th>
                            <th onclick="sortBy('checkin_at')">Check-in</th>
                            <th onclick="sortBy('wa_sent')">WA</th>
                            <th>Alasan / Pesan</th>
                            <th onclick="sortBy('created_at')">Waktu Daftar</th>
                            <th style="width:40px"></th>
                        </tr>
                    </thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <!-- Pagination info -->
            <div id="paginationInfo" class="text-xs text-gray-600 p-3 border-t border-white/5 text-right" style="display:none;"></div>
        </div>

        <p class="text-xs text-gray-700 text-center mt-4">&copy; 2026 &nbsp;BPD HIPMI OTOMOTIF JAWA BARAT ‚Äì Dashboard Internal</p>
    </div>
</div>

<!-- ==================== CONFIRM DELETE MODAL ==================== -->
<div id="confirmModal">
    <div class="card max-w-sm w-full overflow-hidden">
        <div class="p-6 space-y-4 text-center">
            <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);">
                <svg class="w-6 h-6 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </div>
            <h3 class="font-semibold text-lg">Hapus Data Ini?</h3>
            <p class="text-sm text-gray-400" id="confirmMsg">Data peserta akan dihapus secara permanen.</p>
            <div class="flex gap-3 mt-4">
                <button onclick="closeConfirm()" class="flex-1 py-2 rounded-lg border border-white/10 text-gray-400 text-sm hover:bg-white/5 transition">Batal</button>
                <button onclick="confirmDelete()" class="flex-1 py-2 rounded-lg bg-red-700 text-white text-sm font-semibold hover:bg-red-600 transition">Hapus</button>
            </div>
        </div>
    </div>
</div>

<!-- ==================== QR SCANNER MODAL ==================== -->
<div id="scanModal">
    <div class="card max-w-sm w-full overflow-hidden">
        <div class="gold-gradient h-1 w-full"></div>
        <div class="p-5 space-y-4">
            <div class="flex items-center justify-between">
                <h3 class="font-semibold text-yellow-400">üì∑ Scan QR Tamu</h3>
                <button onclick="closeScanner()" class="text-gray-500 hover:text-white text-xl leading-none">&times;</button>
            </div>
            <p class="text-xs text-gray-500">Arahkan kamera ke QR Code pada undangan digital tamu. Check-in otomatis dilakukan saat QR berhasil dibaca.</p>

            <!-- Camera preview -->
            <div class="relative rounded-xl overflow-hidden bg-black" style="min-height:240px;">
                <video id="scanVideo" autoplay playsinline muted></video>
                <canvas id="scanCanvas" class="hidden"></canvas>
                <div class="scan-ring"></div>
                <div id="scanLine" style="position:absolute;top:50%;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,rgba(191,149,63,0.8),transparent);animation:scanLine 1.8s ease-in-out infinite;"></div>
            </div>
            <style>@keyframes scanLine { 0%{top:20%} 50%{top:75%} 100%{top:20%} }</style>

            <!-- Manual input fallback -->
            <div class="space-y-2">
                <p class="text-xs text-gray-600">Atau masukkan token manual:</p>
                <div class="flex gap-2">
                    <input type="text" id="manualToken" placeholder="Paste token undangan..."
                        class="flex-1 bg-black border border-gray-700 text-white text-xs rounded-lg px-3 py-2 focus:border-yellow-600 outline-none">
                    <button onclick="processToken(document.getElementById('manualToken').value.trim())"
                        class="btn-gold px-4 py-2 rounded-lg text-xs whitespace-nowrap">Check-in</button>
                </div>
            </div>

            <p id="scanStatus" class="text-xs text-center text-gray-600">Menunggu QR...</p>
        </div>
    </div>
</div>

<!-- ==================== CHECK-IN RESULT MODAL ==================== -->
<div id="checkinModal">
    <div class="card max-w-sm w-full overflow-hidden">
        <div class="gold-gradient h-1 w-full"></div>
        <div class="p-7 space-y-4 text-center">
            <div class="text-6xl" id="checkinResultIcon">‚úÖ</div>
            <h3 class="text-xl font-bold" id="checkinResultTitle">Check-in Berhasil!</h3>
            <div class="rounded-xl p-4 space-y-2 text-left" style="background:rgba(191,149,63,0.05);border:1px solid rgba(191,149,63,0.2);">
                <p class="text-sm font-semibold text-white" id="checkinResultNama">‚Äî</p>
                <p class="text-xs text-gray-400" id="checkinResultKomunitas">‚Äî</p>
                <p class="text-xs text-gray-500 mt-2" id="checkinResultTime">‚Äî</p>
            </div>
            <button onclick="closeCheckinModal()" class="btn-gold w-full py-3 rounded-lg text-sm uppercase tracking-wide">
                OK
            </button>
        </div>
    </div>
</div>

<!-- Toast -->
<div id="toast">
    <div class="flex items-start gap-3">
        <span id="toastIcon"></span>
        <div>
            <p id="toastTitle" class="font-semibold text-sm"></p>
            <p id="toastMsg" class="text-xs mt-0.5 opacity-80"></p>
        </div>
    </div>
</div>

<script>
// ================================================================
//  STATE
// ================================================================
let allData = [];
let sortCol = 'id';
let sortDir = 'desc';
let pendingDeleteId = null;

// ================================================================
//  AUTH
// ================================================================
function checkPin() {
    const pin = document.getElementById('pinInput').value;
    document.getElementById('pinErr').classList.add('hidden');
    if (pin === CONFIG.ADMIN_PIN) {
        sessionStorage.setItem('admin_auth', '1');
        showDashboard();
    } else {
        document.getElementById('pinErr').classList.remove('hidden');
        document.getElementById('pinInput').value = '';
        updatePinDots('');
    }
}

function showDashboard() {
    document.getElementById('loginArea').style.display = 'none';
    document.getElementById('reportArea').style.display = 'block';
    loadData();
}

function logout() {
    sessionStorage.removeItem('admin_auth');
    document.getElementById('loginArea').style.display = 'flex';
    document.getElementById('reportArea').style.display = 'none';
    document.getElementById('pinInput').value = '';
    updatePinDots('');
}

// Auto-login jika sesi masih aktif
if (sessionStorage.getItem('admin_auth') === '1') {
    showDashboard();
}

document.getElementById('pinInput').addEventListener('keydown', (e) => { if (e.key === 'Enter') checkPin(); });
document.getElementById('pinInput').addEventListener('input', (e) => updatePinDots(e.target.value));

function updatePinDots(val) {
    for (let i = 0; i < 8; i++) {
        document.getElementById('dot' + i)?.classList.toggle('filled', i < val.length);
    }
}

// ================================================================
//  LOAD DATA
// ================================================================
async function loadData() {
    document.getElementById('loadingState').style.display = 'flex';
    document.getElementById('tableWrap').style.display = 'none';
    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('paginationInfo').style.display = 'none';

    try {
        const res = await CONFIG.tursoFetch([{
            type: "execute",
            stmt: { sql: "SELECT id, nama, komunitas, whatsapp, status, alasan, invite_token, checkin_at, wa_sent, created_at FROM attendance ORDER BY id DESC" }
        }]);

        const result = res.results?.[0]?.response?.result;
        const cols   = result?.cols?.map(c => c.name) ?? [];
        const rows   = result?.rows ?? [];

        allData = rows.map(row => {
            const obj = {};
            cols.forEach((col, i) => { obj[col] = row[i]?.value ?? ''; });
            return obj;
        });

        buildKomunitasFilter();
        updateStats();
        renderTable();

    } catch (err) {
        console.error(err);
        if (err.message === 'TOKEN_PLACEHOLDER') {
            showToast('Setup', 'Isi TURSO_TOKEN di js/config.js terlebih dahulu.', 'error');
        } else if (err.message === 'FILE_PROTOCOL') {
            showToast('Gunakan HTTP Server', 'Buka via Live Server atau hosting, bukan file:// langsung.', 'error');
        } else {
            showToast('Error', 'Gagal mengambil data: ' + (err.message || 'unknown'), 'error');
        }
    } finally {
        document.getElementById('loadingState').style.display = 'none';
    }
}

// ================================================================
//  STATS
// ================================================================
function updateStats() {
    const total   = allData.length;
    const hadir   = allData.filter(r => r.status === 'Hadir').length;
    const tidak   = total - hadir;
    const pct     = total > 0 ? Math.round((hadir / total) * 100) : 0;
    const checkin = allData.filter(r => !!r.checkin_at).length;
    document.getElementById('statTotal').textContent   = total;
    document.getElementById('statHadir').textContent   = hadir;
    document.getElementById('statTidak').textContent   = tidak;
    document.getElementById('statPct').textContent     = pct + '%';
    document.getElementById('statCheckin').textContent = checkin;
}

// ================================================================
//  FILTER KOMUNITAS
// ================================================================
function buildKomunitasFilter() {
    const sel   = document.getElementById('filterKomunitas');
    const prev  = sel.value;
    const unique = [...new Set(allData.map(r => r.komunitas).filter(Boolean))].sort();
    sel.innerHTML = '<option value="">Semua Komunitas</option>' +
        unique.map(k => `<option value="${escHtml(k)}">${escHtml(k)}</option>`).join('');
    sel.value = prev;
}

// ================================================================
//  SORT
// ================================================================
function sortBy(col) {
    if (sortCol === col) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
    else { sortCol = col; sortDir = 'asc'; }
    // update header classes
    document.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc','sort-desc'));
    const thEls = document.querySelectorAll('th');
    // find the matching th by onclick
    thEls.forEach(th => {
        if (th.getAttribute('onclick') === `sortBy('${col}')`) {
            th.classList.add(sortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
    });
    renderTable();
}

// ================================================================
//  RENDER TABLE
// ================================================================
function renderTable() {
    const search    = document.getElementById('searchInput').value.toLowerCase();
    const filterSt  = document.getElementById('filterStatus').value;
    const filterKm  = document.getElementById('filterKomunitas').value;
    const filterCi  = document.getElementById('filterCheckin').value;  // 'yes' | 'no' | ''

    let filtered = allData.filter(r => {
        const matchSearch = !search ||
            r.nama?.toLowerCase().includes(search) ||
            r.komunitas?.toLowerCase().includes(search) ||
            r.whatsapp?.includes(search);
        const matchSt = !filterSt || r.status === filterSt;
        const matchKm = !filterKm || r.komunitas === filterKm;
        const matchCi = !filterCi ||
            (filterCi === 'yes' ? !!r.checkin_at : !r.checkin_at);
        return matchSearch && matchSt && matchKm && matchCi;
    });

    // Sort
    filtered.sort((a, b) => {
        const va = (a[sortCol] ?? '').toString().toLowerCase();
        const vb = (b[sortCol] ?? '').toString().toLowerCase();
        if (va < vb) return sortDir === 'asc' ? -1 : 1;
        if (va > vb) return sortDir === 'asc' ? 1 : -1;
        return 0;
    });

    const body = document.getElementById('tableBody');

    if (filtered.length === 0) {
        body.innerHTML = '';
        document.getElementById('tableWrap').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('paginationInfo').style.display = 'none';
        return;
    }

    document.getElementById('emptyState').style.display = 'none';
    document.getElementById('tableWrap').style.display = 'block';

    body.innerHTML = filtered.map((r, i) => {
        const badge = r.status === 'Hadir'
            ? `<span class="badge-hadir">‚úÖ Hadir</span>`
            : `<span class="badge-tidak">‚ùå Tidak Hadir</span>`;

        let ciBadge;
        if (r.checkin_at) {
            ciBadge = `<span class="badge-checkin">üé´ ${formatDate(r.checkin_at)}</span>`;
        } else if (r.status === 'Hadir') {
            ciBadge = `<button onclick="manualCheckin(${r.id},'${escHtml(r.nama)}')"
                class="text-xs px-2 py-1 rounded border border-yellow-700/40 text-yellow-700 hover:bg-yellow-900/20 transition whitespace-nowrap">
                Tandai Hadir
            </button>`;
        } else {
            ciBadge = `<span class="text-gray-700 text-xs">‚Äî</span>`;
        }

        const ts = r.created_at ? formatDate(r.created_at) : '‚Äî';

        // WA sent badge
        const waBadge = r.wa_sent == 1
            ? `<span class="badge-wa-sent" title="Pesan WA berhasil dikirim">‚úÖ Terkirim</span>`
            : `<button onclick="resendWA(${r.id},'${escHtml(r.nama)}','${r.whatsapp}','${escHtml(r.komunitas)}','${r.status}','${encodeURIComponent(r.invite_token || '')}')" 
                class="text-xs px-2 py-1 rounded border border-green-800/50 text-green-700 hover:bg-green-900/20 transition whitespace-nowrap">
                üì§ Kirim WA
              </button>`;

        // Invite link shortcut
        const invLink = r.invite_token
            ? `<a href="invitation.html?token=${encodeURIComponent(r.invite_token)}" target="_blank"
                title="Buka undangan digital"
                class="ml-1 text-yellow-800 hover:text-yellow-400 transition">üéüÔ∏è</a>`
            : '';

        return `<tr>
            <td class="text-gray-600 text-xs">${i + 1}</td>
            <td class="font-medium text-white">${escHtml(r.nama)}${invLink}</td>
            <td class="text-gray-300">${escHtml(r.komunitas)}</td>
            <td>
                <a href="https://wa.me/${r.whatsapp}" target="_blank"
                   class="text-yellow-600 hover:text-yellow-400 transition text-xs">
                    ${escHtml(r.whatsapp)}
                </a>
            </td>
            <td>${badge}</td>
            <td>${ciBadge}</td>
            <td>${waBadge}</td>
            <td class="text-gray-400 text-xs" style="max-width:160px;">${escHtml(r.alasan) || '‚Äî'}</td>
            <td class="text-gray-500 text-xs whitespace-nowrap">${ts}</td>
            <td>
                <button class="btn-del" onclick="requestDelete(${r.id}, '${escHtml(r.nama)}')" title="Hapus">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                    </svg>
                </button>
            </td>
        </tr>`;
    }).join('');

    document.getElementById('paginationInfo').textContent =
        `Menampilkan ${filtered.length} dari ${allData.length} data`;
    document.getElementById('paginationInfo').style.display = 'block';
}

// ================================================================
//  DELETE
// ================================================================
function requestDelete(id, nama) {
    pendingDeleteId = id;
    document.getElementById('confirmMsg').textContent = `Data "${nama}" akan dihapus secara permanen.`;
    document.getElementById('confirmModal').classList.add('show');
}

function closeConfirm() {
    pendingDeleteId = null;
    document.getElementById('confirmModal').classList.remove('show');
}

async function confirmDelete() {
    if (!pendingDeleteId) return;
    closeConfirm();
    try {
        await CONFIG.tursoFetch([{
            type: "execute",
            stmt: { sql: "DELETE FROM attendance WHERE id = ?", args: [{type:"integer",value:String(pendingDeleteId)}] }
        }]);
        allData = allData.filter(r => r.id !== pendingDeleteId);
        updateStats();
        buildKomunitasFilter();
        renderTable();
        showToast('Berhasil', 'Data peserta telah dihapus.', 'success');
    } catch {
        showToast('Error', 'Gagal menghapus data.', 'error');
    }
}

// Close modal on backdrop click
document.getElementById('confirmModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('confirmModal')) closeConfirm();
});

// ================================================================
//  EXPORT EXCEL
// ================================================================
function exportExcel() {
    const search   = document.getElementById('searchInput').value.toLowerCase();
    const filterSt = document.getElementById('filterStatus').value;
    const filterKm = document.getElementById('filterKomunitas').value;

    let data = allData.filter(r => {
        const matchSearch = !search || r.nama?.toLowerCase().includes(search) || r.komunitas?.toLowerCase().includes(search) || r.whatsapp?.includes(search);
        const matchSt = !filterSt || r.status === filterSt;
        const matchKm = !filterKm || r.komunitas === filterKm;
        return matchSearch && matchSt && matchKm;
    });

    if (data.length === 0) {
        showToast('Tidak ada data', 'Tidak ada data untuk diekspor.', 'warning');
        return;
    }

    const header = ['No.', 'Nama Lengkap', 'Komunitas / Instansi', 'Nomor WhatsApp', 'Status RSVP', 'Check-in', 'Alasan / Pesan', 'Waktu Daftar'];
    const rows   = data.map((r, i) => [
        i + 1,
        r.nama,
        r.komunitas,
        r.whatsapp,
        r.status,
        r.checkin_at ? formatDate(r.checkin_at) : '',
        r.alasan || '',
        r.created_at || ''
    ]);

    const ws = XLSX.utils.aoa_to_sheet([header, ...rows]);
    // Column widths
    ws['!cols'] = [{ wch: 5 }, { wch: 28 }, { wch: 28 }, { wch: 18 }, { wch: 16 }, { wch: 22 }, { wch: 35 }, { wch: 22 }];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Daftar Hadir');

    // Summary sheet
    const sum = [
        ['Laporan Kehadiran ‚Äì BASNOM HIPMI OTOMOTIF JAWA BARAT'],
        [],
        ['Total RSVP',      allData.length],
        ['Konfirmasi Hadir', allData.filter(r => r.status === 'Hadir').length],
        ['Tidak Hadir',      allData.filter(r => r.status !== 'Hadir').length],
        ['Sudah Check-in',   allData.filter(r => !!r.checkin_at).length],
        ['Diekspor pada',    new Date().toLocaleString('id-ID')]
    ];
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sum), 'Ringkasan');

    const today = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(wb, `Daftar_Hadir_HIPMI_Otomotif_${today}.xlsx`);
    showToast('Berhasil', `${data.length} data diekspor ke Excel.`, 'success');
}

// ================================================================
//  HELPERS
// ================================================================
function formatDate(str) {
    if (!str) return '‚Äî';
    try {
        const d = new Date(str);
        return d.toLocaleString('id-ID', { day:'2-digit', month:'short', year:'numeric', hour:'2-digit', minute:'2-digit' });
    } catch { return str; }
}

function escHtml(str) {
    return String(str ?? '')
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}

function showToast(title, msg, type = 'error') {
    const t = document.getElementById('toast');
    const colors = {
        error:   { bg:'#2d1a1a', border:'#7f1d1d', icon:'‚ùå' },
        success: { bg:'#1a2d1a', border:'#14532d', icon:'‚úÖ' },
        warning: { bg:'#2d2210', border:'#713f12', icon:'‚ö†Ô∏è' }
    };
    const c = colors[type] || colors.error;
    t.style.background = c.bg;
    t.style.border = `1px solid ${c.border}`;
    t.style.color = '#fff';
    document.getElementById('toastIcon').textContent = c.icon;
    document.getElementById('toastTitle').textContent = title;
    document.getElementById('toastMsg').textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 4000);
}

// Setup check on load
(function checkSetup() {
    const msgs = [];
    if (!CONFIG.TURSO_TOKEN || CONFIG.TURSO_TOKEN.endsWith('...')) {
        msgs.push('‚ö† <strong>TURSO_TOKEN</strong> belum diisi di js/config.js.');
    }
    if (location.protocol === 'file:') {
        msgs.push('‚ö† Dibuka via <strong>file://</strong> ‚Äî gunakan <strong>Live Server</strong> atau deploy ke hosting.');
    }
    if (msgs.length > 0) {
        const el = document.getElementById('setupWarnAdmin');
        el.innerHTML = msgs.join('<br>');
        el.classList.remove('hidden');
    }
})();

// ================================================================
//  QR SCANNER
// ================================================================
let scanStream   = null;
let scanInterval = null;
let scannerBusy  = false;

function openScanner() {
    document.getElementById('scanModal').classList.add('show');
    document.getElementById('scanStatus').textContent = 'Meminta akses kamera...';
    document.getElementById('manualToken').value = '';
    scannerBusy = false;

    if (!navigator.mediaDevices?.getUserMedia) {
        document.getElementById('scanStatus').textContent = '‚ö†Ô∏è Browser tidak mendukung kamera. Gunakan input manual.';
        return;
    }

    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            scanStream = stream;
            const video = document.getElementById('scanVideo');
            video.srcObject = stream;
            video.play();
            document.getElementById('scanStatus').textContent = 'Arahkan ke QR Code undangan...';
            startScanLoop();
        })
        .catch(err => {
            console.warn('Camera error:', err);
            document.getElementById('scanStatus').textContent = '‚ö†Ô∏è Akses kamera ditolak. Gunakan input manual di bawah.';
        });
}

function startScanLoop() {
    const video  = document.getElementById('scanVideo');
    const canvas = document.getElementById('scanCanvas');
    const ctx    = canvas.getContext('2d');

    scanInterval = setInterval(() => {
        if (scannerBusy || video.readyState !== video.HAVE_ENOUGH_DATA) return;
        canvas.width  = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: 'dontInvert' });
        if (code?.data) {
            // Extract token from URL or raw token
            let token = code.data;
            try {
                const url = new URL(token);
                token = url.searchParams.get('token') || token;
            } catch {}
            processToken(token);
        }
    }, 400);
}

function closeScanner() {
    clearInterval(scanInterval);
    scanInterval = null;
    if (scanStream) { scanStream.getTracks().forEach(t => t.stop()); scanStream = null; }
    document.getElementById('scanModal').classList.remove('show');
    document.getElementById('scanVideo').srcObject = null;
}

async function processToken(token) {
    if (!token || scannerBusy) return;
    scannerBusy = true;
    document.getElementById('scanStatus').textContent = '‚è≥ Memproses token...';

    try {
        // Lookup by token
        const res = await CONFIG.tursoFetch([{
            type: "execute",
            stmt: {
                sql: "SELECT id, nama, komunitas, status, checkin_at FROM attendance WHERE invite_token = ? LIMIT 1",
                args: [{ type:"text", value: token }]
            }
        }]);

        const result = res.results?.[0]?.response?.result;
        const cols   = result?.cols?.map(c => c.name) ?? [];
        const rows   = result?.rows ?? [];

        if (rows.length === 0) {
            document.getElementById('scanStatus').textContent = '‚ùå Token tidak ditemukan!';
            showCheckinResult('‚ùå', 'Token Tidak Valid', 'Undangan tidak ditemukan di database.', '', true);
            setTimeout(() => { scannerBusy = false; document.getElementById('scanStatus').textContent = 'Arahkan ke QR Code undangan...'; }, 3000);
            return;
        }

        const obj = {};
        cols.forEach((c, i) => { obj[c] = rows[0][i]?.value ?? ''; });

        if (obj.checkin_at) {
            // Already checked in
            document.getElementById('scanStatus').textContent = '‚ö†Ô∏è Sudah check-in sebelumnya!';
            showCheckinResult('‚ö†Ô∏è', 'Sudah Check-in', obj.nama, obj.komunitas + '\nCheck-in: ' + formatDate(obj.checkin_at), true);
            closeScanner();
            return;
        }

        // Perform check-in
        const now = new Date().toISOString();
        await CONFIG.tursoFetch([{
            type: "execute",
            stmt: {
                sql: "UPDATE attendance SET checkin_at = ? WHERE id = ?",
                args: [{ type:"text", value: now }, { type:"integer", value: String(obj.id) }]
            }
        }]);

        // Update local data
        const local = allData.find(r => r.id == obj.id);
        if (local) local.checkin_at = now;
        updateStats();
        renderTable();

        document.getElementById('scanStatus').textContent = '‚úÖ Check-in berhasil!';
        showCheckinResult('‚úÖ', 'Check-in Berhasil!', obj.nama, obj.komunitas, false, formatDate(now));
        closeScanner();

    } catch (err) {
        console.error(err);
        document.getElementById('scanStatus').textContent = '‚ùå Error: ' + err.message;
        setTimeout(() => { scannerBusy = false; }, 2500);
    }
}

// ================================================================
//  RESEND WA
// ================================================================
async function resendWA(id, nama, whatsapp, komunitas, status, tokenEncoded) {
    if (!confirm(`Kirim ulang pesan WhatsApp ke ${nama} (${whatsapp})?`)) return;
    const token = decodeURIComponent(tokenEncoded);
    const base  = `${location.origin}${location.pathname.replace(/\/[^/]*$/, '')}`;
    const inviteURL = token ? `${base}/invitation.html?token=${token}` : '';
    const msg = CONFIG.buildWAMessage(nama, komunitas, status, inviteURL);
    try {
        const ok = await CONFIG.sendWA(whatsapp, msg);
        if (!ok) throw new Error('WA gateway menolak request. Cek kredensial di config.js');
        await CONFIG.tursoFetch([{
            type: 'execute',
            stmt: { sql: 'UPDATE attendance SET wa_sent = 1 WHERE id = ?', args: [{type:'integer',value:String(id)}] }
        }]);
        const local = allData.find(r => r.id == id);
        if (local) local.wa_sent = 1;
        renderTable();
        showToast('WA Terkirim', `Pesan berhasil dikirim ke ${nama}.`, 'success');
    } catch (err) {
        showToast('Gagal Kirim WA', err.message, 'error');
    }
}

async function manualCheckin(id, nama) {
    if (!confirm(`Tandai "${nama}" sebagai hadir (check-in)?`)) return;
    const now = new Date().toISOString();
    try {
        await CONFIG.tursoFetch([{
            type: "execute",
            stmt: {
                sql: "UPDATE attendance SET checkin_at = ? WHERE id = ?",
                args: [{ type:"text", value: now }, { type:"integer", value: String(id) }]
            }
        }]);
        const local = allData.find(r => r.id == id);
        if (local) local.checkin_at = now;
        updateStats();
        renderTable();
        showToast('Check-in Berhasil', `${nama} telah ditandai hadir.`, 'success');
    } catch (err) {
        showToast('Error', 'Gagal check-in: ' + err.message, 'error');
    }
}

function showCheckinResult(icon, title, nama, sub, isWarn = false, time = '') {
    document.getElementById('checkinResultIcon').textContent  = icon;
    document.getElementById('checkinResultTitle').textContent = title;
    document.getElementById('checkinResultTitle').style.color = isWarn ? '#f87171' : '#4ade80';
    document.getElementById('checkinResultNama').textContent  = nama;
    document.getElementById('checkinResultKomunitas').textContent = sub;
    document.getElementById('checkinResultTime').textContent  = time ? 'üïê Check-in: ' + time : '';
    document.getElementById('checkinModal').classList.add('show');
}

function closeCheckinModal() {
    document.getElementById('checkinModal').classList.remove('show');
    scannerBusy = false;
}

// Close modals on backdrop click
document.getElementById('scanModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('scanModal')) closeScanner();
});
document.getElementById('checkinModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('checkinModal')) closeCheckinModal();
});
</script>
</body>
</html>
